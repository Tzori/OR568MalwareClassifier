#===============================================================================
library(dplyr)
library(ggplot2)
library(reshape2)
library(caret)
library(corrplot)
library(lattice)
library(e1071)
#===============================================================================
# Load dataset for your machine 
#===============================================================================
# Set your working directory to the directory where all project R Scripts
cwd <- getwd()
file.name <- "Kaggle-data-FINAL.csv"
paste(cwd, file.name ,sep="/")
df <- read.csv(paste(cwd, file.name ,sep="/"))
data.load <- df
#===============================================================================
# Unprocessed Data Heatmap to Display Variables
#===============================================================================
# Create the cleaned dataframe heatmap plot
data.load <- data.load[, sapply(data.load, is.numeric)]
cor_matrix <- cor(data.load)
cor_melted <- melt(cor_matrix)
subtitle.heatmap <- paste("Number of Remaining Variables:", ncol(data.load),
                          "| Response Var: legitimate")
# Plot the heatmap
ggplot(data = cor_melted, aes(x = Var1, y = Var2, fill = value)) + 
  geom_tile(color = "black") +
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", 
                       midpoint = 0, limits = c(-1, 1),
                       name = "Correlation") +
  coord_fixed() +
  labs(x="Variable 1", y="Variable 2", 
       title="Unprocessed Data Variable Heatmap",
       subtitle = subtitle.heatmap) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
#===============================================================================
# Pre-Process Data
# Label the response variable column name
response_var <- "legitimate" 
## Confirm there are no nulls
sum(is.na(df))
## Check for near zero variance using the nearZeroVar function
zeroVar <- nearZeroVar(df, saveMetrics=FALSE)
## Column index 10, 30, 31, 32, 33, and 47 all have zero  variance
zeroVar.names <- colnames(df[zeroVar])
trans1 <- (paste("ZeroVar column removed:", zeroVar.names, collapse = "\n"))
##Dropping near zero variance columns
df_trans1 <- df[, -zeroVar] 
##Drop the ID column because this is an index and is non-informational as well as the md5 column
id.columns <- colnames(df_trans1[1:2])
df_trans2 <- select(df_trans1, -id.columns)
trans2 <- (paste("ID column removed:", id.columns, collapse = "\n"))
## Find highly correlated variables; remove corr magnitude .8 or higher
corr_matrix <- cor(df_trans2)
high_corr <- findCorrelation(corr_matrix, cutoff = 0.8)
high.corr.names <- names(df_trans2)[high_corr]
trans3 <- (paste("High Correlation removed:", high.corr.names, collapse = "\n"))

##Remove highly correlated variables from data frame
df_trans3 <- df_trans2[, -high_corr]
##Convert outcome variable to 2-level factor
df_trans3$legitimate <- as.factor(df_trans3$legitimate)

# Removal Recap
df.preprocessed <- df_trans3
cat(trans1, trans2, trans3, sep="\n")
file.export <- paste(cwd,"preprocessed_data.csv",sep="/")
write.csv(df.preprocessed, file.export, row.names=FALSE)
#===============================================================================
# Preprocessed Data Heatmap to Display Variables
#===============================================================================
# Set your working directory to the directory where all project R Scripts
cwd <- getwd()
file.name <- "preprocessed_data.csv"
paste(cwd, file.name ,sep="/")
df_cleaned <- read.csv(paste(cwd, file.name ,sep="/"))
# Create the cleaned dataframe heatmap plot
cor_matrix <- cor(df_cleaned)
cor_melted <- melt(cor_matrix)
subtitle.heatmap <- paste("Number of Remaining Variables:", ncol(df_cleaned),
                          "| Response Var: legitimate")
# Plot the heatmap
ggplot(data = cor_melted, aes(x = Var1, y = Var2, fill = value)) + 
  geom_tile(color = "black") +
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", 
                       midpoint = 0, limits = c(-1, 1),
                       name = "Correlation") +
  coord_fixed() +
  labs(x="Variable 1", y="Variable 2", 
       title="Preprocessed Data Variable Heatmap",
       subtitle = subtitle.heatmap) +
  theme(axis.text.x = element_text(angle = 55, hjust = 1))
