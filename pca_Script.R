setwd("C:/Rprojects/MalwareDataset - Github/OR568MalwareClassifier/OR568MalwareClassifier")
getwd()
install.packages("AppliedPredictiveModeling")
install.packages("dplyr")
install.packages("tidyr")
install.packages("Correlplot")
install.packages("lattice")
install.packages("caret")
library(lattice)
library(AppliedPredictiveModeling)
library(dplyr)
library(tidyr)
library(ggplot2)
library(corrplot)
library(caret)
library(e1071)
cwd <- getwd()
file.name <- "Kaggle-data-FINAL.csv"
paste(cwd, file.name ,sep="/")
kdatafinal <- read.csv(paste(cwd, file.name ,sep="/"))
kdatafinal
str(kdatafinal)

## Confirm there are no nulls
sum(is.na(kdatafinal))
null_cols <- which(colSums(is.na(kdatafinal)) > 0)
null_cols
sum(is.na(kdatafinal))
zeroVar <- nearZeroVar(kdatafinal, saveMetrics=FALSE)
zeroVar
## Column index 10, 30, 31, 32, 33, and 47 all have zero  variance
  zeroVar.names <- colnames(kdatafinal[zeroVar])
zeroVar1 <- (paste("ZeroVar column removed:", zeroVar.names, collapse = "\n"))
##Dropping near zero variance columns
DropZero_Vars <- kdatafinal[, -zeroVar] 
str(DropZero_Vars) # 'data.frame':	216351 obs. of  51 variables. It has ID and md5.
View(DropZero_Vars)
##Drop the ID and md5 
id.columns <- colnames(DropZero_Vars[1:2])
DropZero_Vars2 <- select(DropZero_Vars, -id.columns)# 49 variables
Kdata_df <- (paste("ID column removed:", id.columns, collapse = "\n"))
str(Kdata_df)
View(Kdata_df)

## Find highly correlated variables; remove corr magnitude .8 or higher
corr_matrix <- cor(DropZero_Vars2)
high_corr <- findCorrelation(corr_matrix, cutoff = 0.8)
high.corr.names <- names(DropZero_Vars2)[high_corr]
high.corr.names # shows the 8 variables that highly correlated.
DropZero_Vars3 <- (paste("High Correlation removed:", high.corr.names, collapse = "\n"))

##Remove highly correlated variables from data frame
df_malware <- DropZero_Vars2[, -high_corr]
print(length(df_malware)) # 41 variables in total
View(df_malware)
# dataset for PCA analysis without the response variable
pcadata <- df_malware[,-41]
str(pcadata) # pcadata has only the 40 predictors
length(pcadata)
library(caret)
#Running skeweness to all the dataset (malwaredf)
skewValues <- apply(pcadata,2,skewness)
#Running the PCA for the entire final data set
pcaM <- prcomp(pcadata, center=TRUE, scale. = TRUE )
summary(pcaM)
#Running the PCA for the whole set minus the outcome variable.
#Calculate the cumulative percentage of variance which each component accounts for.The PCA object
#for the Malwaredataset is pcaM1 (does not contain the ID column).
percentVarMalware <- pcaM$sd^2/sum(pcaM$sd^2)*100 
percentVarMalware
plot(percentVarMalware, xlab="Components", ylab="Percentage of Total Variance",
     type="l", main="Scree Plot of PCA Analysis", col = "turquoise")
#The another sub-object called rotation stores the variable loadings, where  rows correspond to 
#predictor variables and columns are associated with the  components.
head(pcaM) # it brings up $x which has the PCs
library(corrplot)
#Running correlation for the predictors
corrMalwaredf <- cor(pcadata)
# filtering hig correlations, cutoff = 0.85
highCorr <- findCorrelation(corrMalwaredf, cutoff = .85)
length(highCorr)
# I will be using factoextra package to create a ggplot2-based for visualization
install.packages("factoextra")
library(factoextra)
library("FactoMineR")
library(FactoMineR)
pcaM <- prcomp(pcadata, scale = TRUE)
pcaM
#the eigenvalues measure the amount of variation retained by each principal component. 
#Eigenvalues are large for the first PCs and small for the subsequent PCs. That is, 
#the first PCs corresponds to the directions with the maximum amount of variation in the data set.
# Get Eigenvalues
eig.val <- get_eigenvalue(pcaM)
eig.val
get_eig(pcaM)
# Eigenvalues
#Visualize eigenvalues (scree plot). 
# The scree plot can be produced using the function fviz_eig()
#or fviz_screeplot() [factoextra package].
fviz_screeplot(pcaM, addlabels = TRUE, ylim = c(0, 40), 
               title = "Scree Plot")

fviz_eig(pcaM)
# Extract the results for variables
varpca <- get_pca_var(pcaM)
varpca
# Contributions of variables to PC1 for the top 5 variables
fviz_contrib(pcaM, choice = "var", axes = 1, top = 5)
fviz_contrib(pcaM, choice = "var", axes = 1:2, top = 11)
# Contributions of variables to PC1
fviz_contrib(pcaM, choice = "var", axes = 1, top = 20)

# Extract the results for individuals
indpca <- get_pca_ind(pcaM)
indpca
# Contributions of variables to PC1. The red dashed line on the graph above indicates 
#the expected average contribution. 

fviz_contrib(pcaM, choice= "var", axes = 1, top = 5)
# Contributions of variables to PC2
fviz_contrib(pcaM, choice = "var", axes = 2, top = 5)
#The total contribution to PC1 and PC2 is obtained with the following R code:
fviz_contrib(pcaM, choice = "var", axes = 1:2, top = 10)

# Create a grouping variable using kmeans
# Create 3 groups of variables (centers = 3)
set.seed(568)
res.km <- kmeans(varpca$coord, centers = 3, nstart = 25)
grp <- as.factor(res.km$cluster)
# Color variables by groups
fviz_pca_var(pcaM, col.var = grp, 
             palette = c("#0073C2FF", "purple", "#868686FF"),
             legend.title = "Cluster")

# Adding Courtney's code
cwd <- getwd()
file.name <- "Kaggle-data-FINAL.csv"
paste(cwd, file.name ,sep="/")
FINALdata <- read.csv(paste(cwd, file.name ,sep="/"))
#create PCA without ID and non-numeric column or the predictor
FINALshortPR <- prcomp(FINALdata[c(3:56)], center = TRUE, scale = TRUE)

# Summary
summary(FINALshortPR)


#set plot
par(mfrow=c(1,1))

#regular scree plot
percentVariancePCA = FINALshortPR$sd^2/sum(FINALshortPR$sd^2)*100
plot(percentVariancePCA, xlab="Components", ylab="Percentage of Total Variance", type="l", main="Scree Plot of PCA Analysis")

#set plot
par(mfrow=c(1,2))

#see if we can remove where eigenvalue is less than 1
screeplot(FINALshortPR, type = "l", npcs = 40, main = "Screeplot of the first 40 PCs")
abline(h = 1, col = "red", lty=5)
legend("topright", legend=c("Eigenvalue=1"),
       col=c("red"), lty=5, cex=0.6)

cumpro <- cumsum(FINALshortPR$sdev^2 / sum(FINALshortPR$sdev^2))
plot(cumpro[0:40], xlab = "PC #", ylab = "Amount of explained variance", main = "Cumulative variance plot")
abline(v = 20, col="blue", lty=5)
abline(h=0.73456, col="blue", lty=5)
legend("topleft", legend=c("Cut-off @ PC20"),
       col=c("blue"), lty=5, cex=0.6)

#set plot
par(mfrow=c(1,1))

#we only account for 12% of variance with first 2 principal components
plot(FINALshortPR$x[,1], FINALshortPR$x[,2], xlab="PC1 (6.502%)", ylab = "PC2 (6.325%)", main=" PC1 / PC2 - plot")


install.packages("factoextra")
library("factoextra")
fviz_pca_ind(FINALshortPR, geom.ind = "point", pointshape = 21, 
             pointsize = 2, 
             fill.ind = factor(FINALdata$legitimate), 
             col.ind = "black", 
             palette = "jco", 
             addEllipses = TRUE,
             label = "var",
             col.var = "black",
             repel = TRUE,
             legend.title = "Legitimate") +
  ggtitle("2D PCA-plot") +
  theme(plot.title = element_text(hjust = 0.5))
fviz_pca_ind

